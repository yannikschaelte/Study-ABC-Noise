# Study-ABC-Noise


This repository contains the code for the analysis on how to efficiently account for measurement noise and model error in sequential ABC. It supplements the paper "Efficient Exact Inference for Dynamical Systems using Sequential Approximate Bayesian Computation", Yannik Sch√§lte and Jan HAsenauer, January 2020.


# Installation


We require python3.6 or later (we used Anaconda3-2018.12), and an installation of the toolbox [pyabc](https://github.com/icb-dcm/pyabc). The used version 0.9.25 has been attached in the [pyabc](pyabc/) directory. This is where most of the code relevant for this work has gone into.

The repository is organized as a python package that can be easily installed by

```sh
pip3 install study_abc_noise
```

from the base folder. All requirements can be installed by

```sh
pip3 install -r requirements.txt
```

We have here logged all versions of the packages we used, using `pip freeze`, though also more recent versions may work.


## Organization


### Folder structure


In the base directory, there are notably the folders `pyabc` and `study_abc_noise`. The former just contains a copy of the pyabc package in the version used, the latter we will describe now in more detail.

* The [model](study_abc_noise/model) folder contains the models that have been used.
* The file [vars](study_abc_noise/vars.py) contains some convenience code that allows handling all models in a similar fashion.
* The ``motivation_...`` folders contain motivating examples what can happen when measurement noise is not corectly accounted for.
* The ``application_...`` folders contain application projects, i.e. the analyses performed for models M1-6 in the main manuscriptp.
 

### In each folder


* In each folder, there may be `README.md` file containing further information.
* Usually, in each folder there is a `script_run.py` or `run.ipynb` or similar file, which contains the code for executing the simulation. Further, there are `script_visualization.py` or `viz.ipynb` or similar files containing code for creating figures, extracting data and other analysis.
* As far as possible, we have made use of jupyter notebooks, which allow to easily combine code and analysis.


# Running the code


We tried to make the code as easily usable and thus the analysis as reproducible as possible, however due to the computational demands of ABC and some of the application examples, some things require a system-specific setup.

Many of the code blocks should run out of the box. For some, however absolute paths were necessary, which will need to be adapted.

For the sampling process we used two samplers: A `pyabc.sampler.MulticoreEvalParallelSampler` and a `pyabc.sampler.RedisEvalParallelSampler`. The former should run out of the box and can exploit parallelism on a single machine. The latter however, which can exploit cluster infrastructure via a redis server, needs a specific setup depending on the cluster infrastructure. See [here](https://pyabc.rtfd.io/en/latest/sampler.html) for further information. The former sampler was used with 4-40 cores on a single machine, the latter was employed with up to 200 cores on a computational cluster.


## Figure guide


Here's where to find the code responsible for the figures contained in the paper and supplement.

**Main manuscript:**

* Figure 1 (Motivation figure for wrong noise assessment for conversion reaction model): [study_abc_noise/motivation_cr/visualize.ipynb](study_abc_noise/motivation_cr/visualize.ipynb).
* Fiure 2 (Concept figure): [study_abc_noise/motivation_cr/img/concept.svg](study_abc_noise/motivation_cr/img/concept.svg).
* Figure 3 (Results figure 1): [study_abc_noise/fig_results_1/alg_verification.svg](study_abc_noise/fig_results_1/alg_verification.svg). It relies on svg files in the folders ``acceptance_rate``, ``estimate_noise_parameters``, ``norm_influence``. Those svg files were generated by the visualization notebooks in the respective folders.
* Figure 4 (Results figure 2): [study_abc_noise/fig_results_2/fig_results_2.svg](study_abc_noise/fig_results_2/fig_results_2.svg). It relies on svg files in the folder ``various_models``. Those svg files were generated by [study_abc_noise/various_models/viz.ipynb](study_abc_noise/various_models/viz.ipynb).
* Figure 5 (Results for the large ODE model M5): [study_abc_noise/application_ode2/visualization.ipynb](study_abc_noise/application_ode2/visualization.ipynb).


**Supplementary information:**

* The figures for the motivation examples were generated by the visualization notebooks in the respective ``motivation_...`` folders.
* The figures for the application examples M1-6 were generated by the visualization notebooks in the respective ``application_...`` folders.
* The figures in the supplementary information comprising information from various models (e.g. on the ESS and sample numbers) were generated in [study_abc_noise/various_models/viz.ipynb](study_abc_noise/various_models/viz.ipynb).
